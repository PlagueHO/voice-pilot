---
post_title: VoicePilot Continuous Integration Pipeline
author1: VoicePilot Team
post_slug: voicepilot-continuous-integration-pipeline
microsoft_alias: voicepilot
featured_image: https://raw.githubusercontent.com/PlagueHO/voice-pilot/main/resources/icon.svg
categories:
  - ci
tags:
  - github-actions
  - quality-gate
  - security
ai_note: Created with assistance from AI pair programming tools.
summary: Documentation for the VoicePilot GitHub Actions workflow defined in .github/workflows/continuous-integration.yml.
post_date: 2025-10-09
---

<!-- markdownlint-disable-next-line MD041 -->
## Overview

The VoicePilot repository ships a single GitHub Actions workflow, `continuous-integration.yml`, that validates pull requests and branch pushes before release. The pipeline currently fans out across two VS Code channels (`stable` and `insiders`) while standardizing on Node.js 22.12.0. Every job executes on `ubuntu-latest` runners and shares the same concurrency guard (`ci-${{ github.ref }}`) to avoid duplicate runs on the same branch.

## Workflow Triggers and Permissions

- **Triggers**: Pull requests targeting `main`, pushes to `feature/**`, `bugfix/**`, and `hotfix/**`, and manual `workflow_dispatch` invocations.
- **Permissions**: Minimal scopes (`contents: read`, `security-events: write`, `id-token: write`) are granted at the workflow level so that downstream SARIF uploads and federated identity scenarios succeed without escalating privileges.

## Matrix Configuration

Each job runs twice—once per VS Code channel—using the following environment contract:

- `matrix.node-version`: `22.12.0`
- `matrix.vs_code_channel`: `stable`, `insiders`
- `VS_CODE_CHANNEL`: propagated to tasks and scanners for channel-aware behavior
- `NODE_OPTIONS`: defaulted to `--max-old-space-size=4096`, but temporarily cleared while the quality gate executes to avoid xvfb memory contention

## Job Breakdown

### Quality Gate (needs: none)

**Purpose**: Build, lint, test, and generate telemetry for the extension via the `scripts/run-quality-gate.mjs` harness.

**Key steps**:

1. Check out the repository (`actions/checkout@v4`).
2. Provision Node.js 22.12.0 (`actions/setup-node@v4`) with npm caching enabled.
3. Install dependencies using `npm ci` to keep lockfile parity.
4. Execute the Quality Gate under a virtual display using `xvfb-run --auto-servernum`. The script orchestrates the `Quality Gate Sequence` VS Code task, chaining linting, unit tests, integration tests, coverage, and performance suites.
5. Collect artifacts (`telemetry/gate-report.json`, coverage reports) into an `artefacts/` folder.
6. Upload artifacts per VS Code channel via `actions/upload-artifact@v4` for later analysis.

The job is marked critical; a failure blocks the rest of the pipeline for the affected matrix entry.

### Lint & Publish Bicep (needs: none)

**Purpose**: Reuse the shared Bicep linting workflow so infrastructure templates stay valid alongside application builds.

**Key steps**:

1. Invoke the reusable workflow `lint-and-publish-bicep.yml` with inherited secrets so any federated credentials remain available.
2. Use the Azure CLI (`az bicep`) to lint `infra/main.bicep` for style and syntax issues.
3. Upload the compiled infrastructure assets from `infra/` as the `infrastructure_bicep` artifact via `actions/upload-artifact@v4`.

This job runs in parallel with the Quality Gate matrix, ensuring infrastructure checks complete even if application tests queue.

### Security & Dependency Scans (needs: Quality Gate)

**Purpose**: Audit dependencies and surface security regressions while the built assets are still fresh.

**Key steps**:

1. Re-checkout and reinstall dependencies to guarantee isolation from the Quality Gate workspace.
2. Run `npm audit --production --audit-level=high`, failing on high (or higher) severity vulnerabilities.
3. Generate an ESLint SARIF report with `npx eslint --ext .ts,.tsx --format @microsoft/eslint-formatter-sarif --output-file eslint-results.sarif .` and upload it to the Security tab via `github/codeql-action/upload-sarif@v3`.
4. Scan the repository with Trivy (`aquasecurity/trivy-action@0.27.0`) targeting file system dependencies. The action is configured to fail for HIGH or CRITICAL issues and produces `trivy-results.sarif` for upload.
5. Invoke the dependency review action on pull requests to flag newly introduced vulnerabilities before merge.

Because this job `needs` the Quality Gate, security scanning never runs against unverified builds.

### Publish Quality Gate Telemetry (needs: Quality Gate, Security & Dependency Scans)

**Purpose**: Consolidate test telemetry for downstream dashboards regardless of earlier failures.

**Key steps**:

1. Download every `quality-gate-*` artifact bundle generated by the matrix runs and merge them locally.
2. Print the raw `quality-gate.json` payload for visibility (defaulting to `{}` if missing).
3. Upload the consolidated telemetry as `quality-gate-telemetry` for retention (14 days) via `actions/upload-artifact@v4`.

This job is guarded with `if: always()` so that telemetry is still published when preceding jobs fail.

## Produced Artifacts

- `quality-gate-${vs_code_channel}`: Contains `quality-gate.json`, `coverage/lcov.info`, and `coverage/coverage-summary.json` for each channel.
- `quality-gate-telemetry`: Aggregated telemetry emitted after both channels complete.
- SARIF uploads: ESLint (`eslint-results.sarif`) and Trivy (`trivy-results.sarif`) files delivered directly to the GitHub Security tab rather than stored as downloadable artifacts.
- `infrastructure_bicep`: Bicep source and compiled templates published by the reusable lint workflow.

## Reproducing the Quality Gate Locally

Developers can mirror the CI checks on Linux or macOS machines with the following steps:

```bash
npm ci
VS_CODE_CHANNEL=stable node scripts/run-quality-gate.mjs
```

Use `VS_CODE_CHANNEL=insiders` to emulate the insiders branch run. When debugging headless display issues, prepend `xvfb-run --auto-servernum --server-args='-screen 0 1280x720x24'` to match the CI launch command.

## Maintenance Notes

- Update this document whenever `continuous-integration.yml` adds or removes jobs, matrix entries, or scanning tools.
- If new artifacts are emitted, ensure both the collection script and this doc list them so that incident responders know where to look.
- The workflow uses `actions/upload-artifact@v4` with a 14-day retention window; adjust the retention window in lockstep with compliance requirements.
