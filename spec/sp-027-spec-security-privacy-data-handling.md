---
title: Privacy & Data Handling Policy
version: 1.0
date_created: 2025-09-26
last_updated: 2025-09-26
owner: Agent Voice Project
tags: [security, privacy, data-handling, compliance, policy]
---

This specification defines the privacy and data handling policy for the Agent Voice VS Code extension. It establishes data classification, retention, redaction, and disposal standards governing audio streams, transcript text, configuration metadata, telemetry, and credentials processed during voice-assisted Copilot workflows. The policy enforces least-data principles across the extension host and webview contexts while ensuring compliance with accessibility and conversational UX requirements defined in UI and COMPONENTS design documents.

## 1. Purpose & Scope

The policy provides authoritative rules for ingesting, processing, caching, transmitting, and disposing user data collected during Agent Voice sessions. It covers:

- Raw and processed audio handled in the webview audio pipeline (SP-006, SP-007)
- Transcript deltas and finalized utterances emitted by realtime STT (SP-009)
- Copilot prompt/response payloads routed through the extension host
- Secrets and tokens managed via Secret Storage (SP-003)
- Telemetry, diagnostics, and logs generated by extension services
- User-facing UI affordances for privacy controls and disclosures (UI.md)

**Intended Audience**: Extension developers, security reviewers, compliance stakeholders, and QA engineers validating data governance.

**Assumptions**:

- Agent Voice operates within VS Code’s extension sandbox with Secret Storage available.
- Azure OpenAI GPT Realtime API is the only external processor of audio and transcript data.
- No persistent analytics pipeline currently exists; future telemetry must comply with this spec.
- OS-level keychain security and Azure Identity mechanisms function as defined in SP-003 and the Technical Reference Index.

## 2. Definitions

- **Audio Frame**: PCM16 mono audio buffer captured or generated inside the webview audio pipeline.
- **Ephemeral Cache**: In-memory store cleared on session end or error without writing to disk.
- **Final Transcript**: Transcript event tagged `final` per SP-009 that is safe for downstream consumption.
- **Partial Transcript**: In-flight transcription segments subject to revision.
- **Personally Identifiable Information (PII)**: Any data that can identify or authenticate the user (names, emails, secrets, access tokens, repository URLs tied to identity).
- **Sensitive Audio Segment**: Audio portion flagged by redaction or user action as containing sensitive content.
- **Redaction Rule**: Pattern-based transformation removing or masking sensitive data before persistence or UI display.
- **Retention Clock**: Timestamp from which retention policies measure maximum lifetime.
- **Data Classification**: Categorization of data assets into `Sensitive`, `Confidential`, or `Operational` tiers described below.
- **Data Processor**: External system (Azure OpenAI) handling audio/transcript processing on behalf of Agent Voice.

## 3. Requirements, Constraints & Guidelines

### Data Classification & Minimization

- **PRI-001**: All data assets SHALL be classified as `Sensitive`, `Confidential`, or `Operational` using the schema in Section 4; default classification is `Sensitive` until assessed.
- **PRI-002**: Only `Operational` data MAY be logged or stored beyond session scope; `Sensitive` and `Confidential` data SHALL remain in ephemeral memory.
- **PRI-003**: Audio frames and partial transcripts SHALL NEVER be persisted to disk, exported, or logged.
- **PRI-004**: Final transcripts MAY be retained in-memory up to 120 seconds solely for reconnection recovery, after which they must be redacted or purged.
- **PRI-005**: Credentials SHALL follow storage boundaries defined in SP-003; privacy policies SHALL NOT override security controls for Secret Storage.

### Access Control & Boundary Enforcement

- **SEC-001**: Cross-context messaging between webview and extension host SHALL strip `Sensitive` fields prior to transit unless the receiving component is explicitly authorized.
- **SEC-002**: Only the Session Manager and authorized consumers (intent processor, Copilot adapter) MAY access finalized transcripts; raw audio exposure is restricted to audio pipeline components.
- **SEC-003**: UI components SHALL display redacted text for any `Sensitive` content, accompanied by an inline privacy indicator consistent with UI.md.
- **SEC-004**: Data forwarded to Azure OpenAI SHALL exclude local identifiers beyond session-scoped correlation tokens.

### Retention & Disposal

- **RET-001**: Retention clocks start at event creation; maximum retention windows are: Audio frames – 5 seconds; Partial transcripts – 30 seconds; Final transcripts – 120 seconds; Diagnostic metadata – 24 hours.
- **RET-002**: Session termination SHALL trigger immediate purge of all audio buffers, transcript caches, and correlation IDs across webview and extension host.
- **RET-003**: Manual purge requests from UI (e.g., “Clear transcript”) SHALL complete within 500 ms and emit `transcript-cleared` events per SP-009.
- **RET-004**: Cached data in failure scenarios (transport loss, crash) SHALL be purged on next activation before any services initialize.

### Redaction & Filtering

- **RED-001**: Transcript aggregator SHALL apply redaction rules before data leaves the webview context, relying on STT redaction metadata when available.
- **RED-002**: Sensitive markers SHALL be preserved as metadata so downstream consumers can respect masking without re-exposing raw values.
- **RED-003**: Users SHALL be able to configure additional redaction patterns via future settings, stored as non-sensitive configuration.
- **RED-004**: Profanity filtering SHALL map to privacy tiers; when `high`, transcripts are sanitized before UI rendering.

### Logging & Telemetry

- **LOG-001**: Logs SHALL include only anonymized identifiers (sessionId, service correlation IDs). User speech or PII SHALL be excluded.
- **LOG-002**: Error objects SHALL redact message payloads before logging.
- **LOG-003**: Telemetry events (if later enabled) SHALL aggregate metrics (latency, counts) without payload content and respect opt-in consent.
- **LOG-004**: Diagnostic exports SHALL require explicit user action and present a confirmation dialog summarizing included data categories.

### User Controls & Transparency

- **UX-001**: UI SHALL display a persistent status indicator summarizing active recording, Azure processing, and retention posture, matching accessibility rules in UI.md.
- **UX-002**: The Voice Control Panel SHALL expose quick actions for pausing audio capture, clearing transcripts, and viewing privacy policy references.
- **UX-003**: When features degrade due to missing consent (e.g., telemetry opt-out), UI SHALL communicate which capabilities are limited.

### Guidelines & Patterns

- **GUD-001**: Prefer data transformations in the webview, closest to capture point, to minimize propagation of sensitive artifacts.
- **GUD-002**: Use structured metadata objects for privacy annotations instead of free-form strings.
- **GUD-003**: Integrate privacy checks into service lifecycle initialization (ServiceInitializable) to fail fast if boundaries are misconfigured.
- **PAT-001**: Apply the Builder pattern for composing privacy-aware transcript payloads.
- **PAT-002**: Use the Observer pattern to notify interested components of purge events without sharing payloads.
- **PAT-003**: Employ Adapter pattern to ensure Copilot integration strips or masks sensitive content before invoking VS Code LM APIs.

### Constraints

- **CON-001**: Privacy controls SHALL NOT increase end-to-end transcription latency beyond 250 ms over baseline defined in SP-009.
- **CON-002**: Memory overhead for privacy buffers SHALL remain under 10 MB per session.
- **CON-003**: Redaction operations SHALL execute within 50 ms per transcript chunk under typical load.

## 4. Interfaces & Data Contracts

### Data Classification Schema

| Class | Description | Examples | Storage Scope | Retention |
| --- | --- | --- | --- | --- |
| Sensitive | Direct identifiers or biometric content | Raw audio frames, user voiceprints, access tokens | Ephemeral webview memory only | ≤ 5 s (audio), cleared on session end |
| Confidential | Derived content containing user meaning | Partial transcripts, final transcripts, Copilot prompts | Ephemeral memory (webview + host), never disk | ≤ 120 s unless user exports |
| Operational | Non-user data required for diagnostics | Session IDs, latency metrics, error codes | Extension host memory/disk | ≤ 24 h configurable |

### Privacy Annotated Transcript Payload

```typescript
interface PrivacyAnnotatedTranscript {
  utteranceId: string;
  sessionId: string;
  content: string; // already redacted
  classification: 'Sensitive' | 'Confidential';
  redactions: RedactionMatch[];
  retentionExpiresAt: string; // ISO timestamp
  metadata: {
    speaker: 'user' | 'assistant' | 'system';
    confidence?: number;
    azureResponseId?: string;
    privacyIndicators: {
      containsPII: boolean;
      containsSecrets: boolean;
      profanityFiltered: boolean;
    };
  };
}
```

### Purge Command Contract

```typescript
type PurgeReason = 'user-requested' | 'session-timeout' | 'policy-update' | 'error-recovery';

interface PurgeCommand {
  type: 'privacy.purge';
  target: 'audio' | 'transcripts' | 'logs' | 'all';
  reason: PurgeReason;
  issuedAt: string;
}

interface PurgeResult {
  target: PurgeCommand['target'];
  status: 'success' | 'partial' | 'failed';
  clearedCount: number;
  retainedCount: number;
  retentionNotes?: string[];
}
```

### Privacy Policy Configuration Snapshot

```typescript
interface PrivacyPolicyConfig {
  retention: {
    audioSeconds: number; // default 5
    partialTranscriptSeconds: number; // default 30
    finalTranscriptSeconds: number; // default 120
    diagnosticsHours: number; // default 24
  };
  redactionRules: RedactionRule[];
  profanityFilter: 'none' | 'medium' | 'high';
  telemetryOptIn: boolean;
  exportEnabled: boolean;
}
```

## 5. Acceptance Criteria

- **AC-001**: Given a live session, When audio capture begins, Then UI displays an active privacy indicator and audio buffers are purged within 5 seconds after use.
- **AC-002**: Given transcripts contain a string matching a redaction rule, When the transcript is emitted to the UI, Then the sensitive substring is masked and metadata lists the rule applied.
- **AC-003**: Given the user invokes “Clear transcript,” When the purge command executes, Then all transcript caches are cleared and a `transcript-cleared` event is broadcast within 500 ms.
- **AC-004**: Given a crash occurs, When the extension restarts, Then initialization verifies no stale transcript or audio data remains before services initialize.
- **AC-005**: Given telemetry is disabled, When a component attempts to send a metric containing transcript content, Then the attempt is rejected and logged without sensitive payload.
- **AC-006**: Given Copilot integration receives a user prompt, When privacy annotations flag PII, Then the prompt is either redacted per policy or blocked with user guidance.
- **AC-007**: Given retention windows expire, When the scheduler runs, Then expired caches are purged without impacting ongoing transcription latency beyond the constraint threshold.

## 6. Test Automation Strategy

- **Test Levels**: Unit tests for redaction utilities and purge handlers; integration tests covering webview ↔ extension messaging and session teardown; end-to-end smoke tests validating UI indicators and user controls.
- **Frameworks**: Mocha + Sinon for unit/integration; Playwright for UI verification; custom harness simulating Azure realtime events to test redaction flow.
- **Test Data Management**: Synthetic transcripts annotated with PII, secrets, profanity, and non-sensitive content; anonymized audio fixtures for latency measurement without real speech.
- **CI/CD Integration**: Privacy test suite executed via `Test Unit`; optional end-to-end privacy guard executed nightly via `Test Extension` to minimize flakiness.
- **Coverage Requirements**: ≥95% statement coverage on redaction and purge modules; 90% branch coverage on retention scheduler.
- **Performance Testing**: Measure redaction latency and purge throughput; ensure CON-001/CON-003 thresholds are met under load.
- **Security Testing**: Static analysis ensuring no logging of sensitive strings; simulated penetration attempts across message boundaries to confirm enforcement.

## 7. Rationale & Context

Agent Voice’s conversational modality processes highly sensitive user data, including spoken ideas, credentials, and project context. Establishing explicit privacy boundaries ensures:

1. **Least Data Exposure**: By constraining storage to ephemeral buffers, the risk of leakage is minimized.
2. **User Trust & Transparency**: UI indicators and controls communicate ongoing processing and empower users to clear data on demand (UI.md).
3. **Regulatory Readiness**: Even without formal compliance targets, the policy aligns with principles from GDPR/CCPA (data minimization, user control).
4. **Interoperability**: Downstream components such as the Copilot adapter can rely on consistent redaction metadata and avoid duplicating privacy logic.
5. **Resilience**: Purge-on-failure guarantees the system returns to a clean state, preventing inadvertent exposure of stale data in logs or UI.

## 8. Dependencies & External Integrations

### External Systems

- **EXT-001**: Azure OpenAI GPT Realtime API – Processes audio and returns transcript events; subject to Microsoft privacy commitments referenced in Technical Reference Index.

### Third-Party Services

- **SVC-001**: Azure Content Filtering – Optional profanity/sensitivity filtering aligning with redaction rules.

### Infrastructure Dependencies

- **INF-001**: WebRTC transport stack (SP-006) – Must honor purge commands by flushing jitter buffers and closing tracks.

### Data Dependencies

- **DAT-001**: Transcript caches defined in SP-009 – Must implement retention windows and purge hooks described herein.
- **DAT-002**: Credential storage (SP-003) – Provides secure handling for sensitive keys without modification by this policy.

### Technology Platform Dependencies

- **PLT-001**: VS Code Secret Storage API – Ensures credentials remain segregated from general data handling.
- **PLT-002**: VS Code Webview messaging – Used to relay redacted transcripts and purge commands.

### Compliance Dependencies

- **COM-001**: Future telemetry and audit specifications (SP-029, SP-056) SHALL inherit constraints from this policy.

## 9. Examples & Edge Cases

```typescript
// Example: Applying privacy annotations before forwarding to Copilot
function buildCopilotPrompt(entry: PrivacyAnnotatedTranscript): string {
  if (entry.metadata.privacyIndicators.containsSecrets) {
    throw new Error('Blocked prompt: redact secrets before sending to Copilot');
  }

  return `User (redacted): ${entry.content}`;
}

// Edge case: Purge triggered during reconnection
sessionManager.on('reconnect', async (sessionId) => {
  await privacyController.issuePurge({
    type: 'privacy.purge',
    target: 'transcripts',
    reason: 'policy-update',
    issuedAt: new Date().toISOString()
  });
  await sttService.resumeTranscription(sessionId);
});
```

Additional edge cases to validate:

- User interrupts while purge is running (ensure no mixed-state transcripts remain).
- Azure returns retroactive corrections (`transcript-redo` events); ensure historical sensitive data is not re-exposed.
- Telemetry disabled mid-session; verify queued metrics drop without leaking content.
- Extension crash after Azure session closes; ensure restart wipes pending buffers before reactivation.

## 10. Validation Criteria

- Privacy unit tests pass with ≥95% coverage.
- End-to-end scenario demonstrates purge operations completing within SLA and UI indicators updating accordingly.
- Manual audit confirms no sensitive strings appear in logs, diagnostics exports, or crash dumps.
- Static analysis shows webview-to-host messages conform to classification schema (no raw audio or unredacted transcripts).
- Penetration test validates boundary enforcement: unauthorized component cannot access sensitive payloads.

## 11. Related Specifications / Further Reading

- [sp-003-spec-security-secret-storage.md](./sp-003-spec-security-secret-storage.md)
- [sp-009-spec-tool-realtime-stt.md](./sp-009-spec-tool-realtime-stt.md)
- [sp-013-spec-design-ui-sidebar-panel.md](./sp-013-spec-design-ui-sidebar-panel.md)
- [COMPONENTS.md](../docs/design/COMPONENTS.md)
- [UI.md](../docs/design/UI.md)
- [Azure OpenAI Realtime API Reference](https://learn.microsoft.com/en-us/azure/ai-foundry/openai/realtime-audio-reference)
